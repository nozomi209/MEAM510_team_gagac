# Vive 自动导航功能说明

## 功能概述

本项目已完整实现基于Vive追踪器的自动导航功能，包括：

1. **Vive数据通信**：servant板通过UART向owner板发送Vive位置和角度数据
2. **自动导航功能**：基于Vive坐标导航到指定目标点
3. **多模式切换**：支持壁障跟随、自动导航到红色/蓝色目标点等模式
4. **障碍物避让**：结合ToF传感器实现安全导航

## 文件结构

- `owner-4.ino` - 主控制程序，集成Vive导航和壁障跟随
- `behavior-wall.ino` - 壁障跟随行为逻辑
- `behavior-vive.ino` - **新增**：Vive自动导航行为逻辑
- `tof-3.ino` - ToF传感器读取

## 使用方法

### 1. 模式切换

通过串口发送以下命令切换模式：

- `W` - 壁障跟随模式（默认）
- `R` - 自动导航到红色目标点
- `B` - 自动导航到蓝色目标点
- `M` - 手动模式

### 2. 目标点配置

在 `owner-4.ino` 中修改目标点坐标（单位：mm）：

```cpp
const float TARGET_RED_X = 2000.0;   // 红色目标X坐标
const float TARGET_RED_Y = 2000.0;   // 红色目标Y坐标
const float TARGET_BLUE_X = 6000.0;  // 蓝色目标X坐标
const float TARGET_BLUE_Y = 2000.0;  // 蓝色目标Y坐标
```

**重要**：需要根据实际的Vive坐标系和目标位置来设置这些值。

### 3. 导航参数调整

在 `behavior-vive.ino` 中可以调整导航参数：

```cpp
const float ANGLE_TOLERANCE = 20.0f;      // 角度容差（度）
const float DISTANCE_TOLERANCE = 5.0f;    // 到达距离阈值（mm）
```

## 工作原理

### 1. Vive数据流

```
servant板 (gagac-2.ino)
  ↓ 每100ms通过UART发送
"VIVE:x.xx,y.yy,a.aa\n"
  ↓
owner板 (owner-4.ino)
  ↓ 解析并存储
viveX, viveY, viveAngle
```

### 2. 自动导航流程

1. **计算目标方向**：根据当前位置和目标位置计算所需角度
2. **转向**：如果角度误差 > 20°，先转向目标方向
3. **前进**：角度正确后，向目标点前进
4. **到达检测**：距离 < 5mm 时认为到达目标
5. **障碍物检测**：结合ToF传感器，遇到障碍物时避让

### 3. 模式切换逻辑

- **壁障跟随模式**：使用ToF传感器进行壁障跟随
- **自动导航模式**：
  - 如果Vive数据有效，使用Vive导航
  - 如果Vive数据无效，自动降级为壁障跟随
  - 30秒超时后自动切换回壁障跟随模式

## 调试信息

系统会定期输出状态信息：

```
Mode: 1 | Vive: X=2500.0, Y=1800.0, A=45.0° | ToF: F=500, L1=200, L2=180
```

- Mode: 0=壁障跟随, 1=红色目标, 2=蓝色目标, 3=手动
- Vive: 当前位置和角度
- ToF: 三个ToF传感器的距离值

## 注意事项

1. **坐标系校准**：确保Vive坐标系与目标点坐标匹配
2. **目标点设置**：根据实际测试环境调整目标点坐标
3. **超时保护**：自动导航有30秒超时，防止卡死
4. **障碍物避让**：系统会结合ToF传感器进行避障
5. **数据有效性**：如果Vive数据无效，系统会自动降级为壁障跟随

## 故障排除

### Vive数据无效
- 检查servant板是否正确发送Vive数据
- 检查UART连接（owner的18接servant的17，owner的17接servant的18）
- 检查Vive基站是否正常工作

### 无法到达目标点
- 检查目标点坐标是否正确
- 调整 `ANGLE_TOLERANCE` 和 `DISTANCE_TOLERANCE` 参数
- 检查是否有障碍物阻挡路径

### 导航不稳定
- 检查Vive数据更新频率（应为10Hz）
- 调整导航速度参数
- 检查ToF传感器是否正常工作

