# VIVE 平面坐标测试指南

> 注意：本文件用于 Vive 双点测试/校准；**实际接线以根目录 `README.md` 为准**。当前代码中 Vive tracker 接在 Servant 的 **GPIO6 / GPIO7**（不是 15/16）。

## 🎯 测量两个平面点的逻辑

### 为什么需要两个点？

使用Vive系统测量两个平面点（两个跟踪器安装在车后两边）的目的是：

1. **确定机器人中心位置**：通过两个点的中点计算机器人在地面上的中心坐标
2. **确定机器人朝向**：通过两个点的连线方向可以确定机器人的朝向角度（连线方向垂直于机器人前进方向）
3. **提高定位精度**：两个点可以提供冗余信息，提高定位的可靠性

### 测量原理

#### 1. 单个点的测量
每个Vive跟踪器通过接收基站发出的激光扫描信号，测量自身在平面上的X和Y坐标：
- **X坐标**：通过K型脉冲的扫描时间计算
- **Y坐标**：通过J型脉冲的扫描时间计算
- 坐标范围：通常在1000-8000之间（具体取决于基站位置和校准参数）

#### 2. 两个点的坐标获取

系统同时使用两个跟踪器（都安装在车后部分的两边）：
- **跟踪器1 (Tracker 1)**：安装在车后左边，连接到GPIO 6，获取坐标 `(X_1, Y_1)`
- **跟踪器2 (Tracker 2)**：安装在车后右边，连接到GPIO 7，获取坐标 `(X_2, Y_2)`

**注意**：代码中变量名为 `viveFront` 和 `viveBack`，但实际安装位置是车后两边的左右两侧。

#### 3. 从两个点计算的信息

**a) 中心位置 (Center Position)**
```
X_center = (X_1 + X_2) / 2
Y_center = (Y_1 + Y_2) / 2
```
- 这是两个跟踪器连线的中点坐标
- 由于两个跟踪器在车后，这个中心点代表车后部的中心位置
- 用于导航和路径规划

**b) 朝向角度 (Orientation Angle)**
```
deltaX = X_2 - X_1
deltaY = Y_2 - Y_1
angle = atan2(deltaY, deltaX) + 90°
```
- 角度范围：-180° 到 +180°
- 两个跟踪器连线方向垂直于机器人前进方向
- 通过连线方向可以确定机器人的朝向
- 用于转向控制和导航

**c) 左右距离 (Distance Verification)**
```
distance = sqrt((X_2 - X_1)² + (Y_2 - Y_1)²)
```
- 用于验证测量是否正确
- 应该接近两个跟踪器之间的实际物理距离（车后部的宽度）

### 你需要做什么事情？

#### 步骤1：硬件安装
1. **安装两个跟踪器**
   - 两个跟踪器都安装在**车后部分的两边**
   - 跟踪器1安装在车后左边，连接到GPIO 6
   - 跟踪器2安装在车后右边，连接到GPIO 7
   - 确保两个跟踪器在同一水平面上
   - 确保两个跟踪器连线垂直于机器人前进方向
   - 记录两个跟踪器之间的实际物理距离（用于验证，通常是车后部的宽度）

2. **连接硬件**
   - 跟踪器1（左边）信号线连接到ESP32的GPIO 6
   - 跟踪器2（右边）信号线连接到ESP32的GPIO 7
   - 确保连接牢固，避免松动

#### 步骤2：系统初始化
1. **上传代码**
   - 将 `gagac-2.ino` 及相关库文件上传到ESP32
   - 确保代码中包含Vive跟踪器的初始化代码

2. **启动系统**
   - 打开串口监视器（115200波特率）
   - 系统会自动初始化两个跟踪器
   - 等待系统就绪提示

#### 步骤3：同步和校准
1. **同步跟踪器**
   - 将机器人移动到基站正前方
   - 确保两个跟踪器都能看到基站
   - 等待几秒钟让系统同步（或发送同步命令）

2. **验证信号质量**
   - 发送 `VIVE_STATUS` 命令
   - 检查两个跟踪器状态都应该是 `2`（接收中）
   - 如果状态不是2，调整机器人位置或基站位置

#### 步骤4：测试测量
1. **启用测试模式**
   ```
   发送命令：VIVE_TEST_ON
   ```

2. **观察数据输出**
   - 系统每200ms输出一次详细数据
   - 检查以下内容：
     - **原始坐标**：两个跟踪器的原始X、Y坐标
     - **滤波后坐标**：经过中值滤波处理后的坐标
     - **中心位置**：计算出的机器人中心坐标
     - **朝向角度**：计算出的机器人朝向
     - **前后距离**：用于验证的距离值

3. **验证测量准确性**
   - **位置验证**：移动机器人到已知位置，检查坐标是否正确
   - **角度验证**：旋转机器人固定角度（如90°），检查角度变化是否正确
   - **距离验证**：检查"左右距离"是否接近两个跟踪器之间的实际物理距离（车后部宽度）

#### 步骤5：校准调整（如需要）
如果发现坐标偏移或角度不准确：

1. **调整校准参数**
   - 编辑 `vive_utils.h` 文件
   - 修改 `VIVE_CALIBRATION_X` 和 `VIVE_CALIBRATION_Y`
   - 重新上传代码并测试

2. **调整滤波参数**
   - 如果坐标跳动严重，可能需要调整滤波算法
   - 在 `vive_utils.cpp` 中的 `processViveData` 函数

### 数据流程图

```
基站激光扫描
    ↓
跟踪器1（车后左边）接收信号 → 计算 X_1, Y_1
跟踪器2（车后右边）接收信号 → 计算 X_2, Y_2
    ↓
数据滤波处理（中值滤波）
    ↓
计算中心位置: (X_center, Y_center) = 两个点的中点
计算朝向角度: angle = 连线方向 + 90°（垂直于连线方向）
计算左右距离: distance = 两个跟踪器之间的距离
    ↓
输出到串口/网页/UART
```

### 注意事项

1. **两个跟踪器必须同时工作**
   - 如果只有一个跟踪器工作，无法计算角度
   - 确保两个跟踪器都在基站覆盖范围内

2. **跟踪器安装位置**
   - 两个跟踪器安装在**车后部分的两边**（左右排列）
   - 确保它们在同一水平面上
   - 确保两个跟踪器连线垂直于机器人前进方向
   - 距离不要太近（建议至少10cm），否则角度计算精度会降低
   - 距离应该接近车后部的实际宽度

3. **坐标系统**
   - X和Y坐标是相对于基站的位置
   - 坐标原点取决于基站的位置和校准参数
   - 移动机器人时，坐标会相应变化

4. **角度定义**
   - 角度0°通常指向Y轴正方向（或根据你的定义）
   - 角度范围是-180°到+180°
   - 角度变化应该与机器人实际旋转方向一致

---

## 📋 测试准备

### 1. 硬件连接
- 确保两个Vive跟踪器正确连接到ESP32：
  - 跟踪器1（车后左）：GPIO 6
  - 跟踪器2（车后右）：GPIO 7
- 确保Vive基站已开启并正常工作
- 确保测试区域在基站覆盖范围内

### 2. 软件准备
- 上传更新后的 `gagac-2.ino` 到ESP32
- 打开串口监视器（波特率：115200）

## 🚀 测试步骤

### 方法一：通过串口命令（推荐用于详细测试）

1. **启用测试模式**
   ```
   在串口监视器中输入：VIVE_TEST_ON
   或简写：TEST_ON
   ```

2. **查看详细数据**
   - 系统会每200ms输出一次详细数据，包括：
     - 两个跟踪器的原始坐标（车后左边和右边）
     - 两个跟踪器的滤波后坐标
     - 跟踪器状态
     - 计算出的中心位置（两个跟踪器连线的中点）
     - 朝向角度（垂直于两个跟踪器连线方向）
     - 两个跟踪器之间的距离（用于验证）

3. **查看当前状态**
   ```
   输入：VIVE_STATUS
   或：STATUS
   ```

4. **关闭测试模式**
   ```
   输入：VIVE_TEST_OFF
   或：TEST_OFF
   ```

### 方法二：通过网页界面

1. 连接到ESP32的WiFi热点：`ESP32-MobileBase`（密码：12345678）
2. 打开浏览器访问：`http://192.168.4.1`
3. 点击 "VIVE_TEST_ON" 按钮启用测试模式
4. 查看串口监视器获取详细数据

## 📊 测试数据解读

### 输出格式示例：
```
═══════════════════════════════════════
📍 VIVE 测试数据 [12345 ms]
───────────────────────────────────────
跟踪器1 (车后左边):
  原始坐标: X=5234, Y=3456
  滤波后:   X=5164, Y=2956
  状态:     2 (0=无信号, 1=仅同步, 2=接收中)
跟踪器2 (车后右边):
  原始坐标: X=5345, Y=3567
  滤波后:   X=5275, Y=3067
  状态:     2 (0=无信号, 1=仅同步, 2=接收中)
───────────────────────────────────────
中心位置: X=5219.50, Y=3011.50
朝向角度: 45.23°
左右距离: 156.78 (用于验证，应接近车后部宽度)
═══════════════════════════════════════
```

### 状态码说明：
- **0 (VIVE_STATUS_NO_SIGNAL)**: 无信号
  - 检查跟踪器连接
  - 检查基站是否开启
  - 检查是否在基站覆盖范围内

- **1 (VIVE_STATUS_SYNC_ONLY)**: 仅同步信号
  - 能收到同步脉冲，但扫描脉冲不稳定
  - 可能是信号质量差或干扰

- **2 (VIVE_STATUS_RECEIVING)**: 正常接收
  - 系统正常工作，能获取坐标

## 🔍 测试检查项

### 1. 信号质量检查
- [ ] 两个跟踪器状态都应该是 2（接收中）
- [ ] 如果状态为 0 或 1，检查硬件连接和基站位置

### 2. 坐标范围检查
- [ ] 原始坐标应该在合理范围内（通常 1000-8000）
- [ ] 滤波后坐标应该在有效范围内（1000-8000）
- [ ] 如果坐标为 0，说明没有收到有效信号

### 3. 位置一致性检查
- [ ] 移动机器人时，坐标应该平滑变化
- [ ] 前后跟踪器的坐标差应该保持相对稳定（机器人长度）
- [ ] 前后距离应该接近机器人的实际长度

### 4. 角度计算检查
- [ ] 朝向角度应该在 -180° 到 180° 之间
- [ ] 旋转机器人时，角度应该平滑变化
- [ ] 角度变化应该与机器人实际旋转方向一致

### 5. 滤波效果检查
- [ ] 滤波后的坐标应该比原始坐标更平滑
- [ ] 不应该有突然的跳跃（除非机器人真的快速移动）

## 🛠️ 常见问题排查

### 问题1：两个跟踪器都显示状态0（无信号）
**可能原因：**
- 基站未开启
- 跟踪器不在基站覆盖范围内
- 硬件连接问题

**解决方法：**
1. 确认基站已开启（LED指示灯）
2. 将机器人移到基站正前方
3. 检查GPIO连接是否正确

### 问题2：状态为1（仅同步）
**可能原因：**
- 信号质量差
- 环境干扰
- 基站位置不佳

**解决方法：**
1. 调整基站位置，确保覆盖测试区域
2. 检查是否有强光干扰
3. 尝试重新同步：移动机器人到基站正前方

### 问题3：坐标跳跃或不稳定
**可能原因：**
- 信号质量差
- 滤波参数需要调整
- 环境干扰

**解决方法：**
1. 检查基站位置和角度
2. 确保测试区域光线稳定
3. 如果问题持续，可能需要调整 `vive_utils.cpp` 中的滤波参数

### 问题4：坐标始终为0
**可能原因：**
- 跟踪器未初始化
- 同步失败

**解决方法：**
1. 发送 `VIVE_STATUS` 查看状态
2. 尝试重新同步：移动机器人到基站正前方等待几秒
3. 检查代码中同步部分是否被注释掉（setup函数中）

## 📝 测试记录建议

建议记录以下信息：
1. **测试时间**
2. **基站位置**（高度、角度、距离）
3. **测试区域坐标范围**（X和Y的最小/最大值）
4. **坐标精度**（移动固定距离，观察坐标变化）
5. **角度精度**（旋转固定角度，观察角度变化）
6. **两个跟踪器之间的距离**（用于验证计算是否正确，应接近车后部宽度）

## 🎯 校准参数调整

如果测试发现坐标偏移，可以调整 `vive_utils.h` 中的校准参数：

```cpp
#define VIVE_CALIBRATION_X 70   // X轴校准偏移
#define VIVE_CALIBRATION_Y 500  // Y轴校准偏移
```

根据测试结果调整这些值，使坐标更准确。

## 📞 测试命令速查

| 命令 | 功能 |
|------|------|
| `VIVE_TEST_ON` 或 `TEST_ON` | 启用测试模式（详细输出） |
| `VIVE_TEST_OFF` 或 `TEST_OFF` | 关闭测试模式 |
| `VIVE_ON` | 启用VIVE系统 |
| `VIVE_OFF` | 关闭VIVE系统 |
| `VIVE_STATUS` 或 `STATUS` | 查看当前状态 |

---

**提示：** 测试时建议将机器人放在不同位置，记录坐标值，验证系统是否正常工作。

