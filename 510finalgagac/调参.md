# 巡墙调参指南

> 所有参数都可以通过网页命令框实时调整，格式：`PARAM:参数名=值`

---

## 🚗 一、基础巡墙参数

### 距离控制

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `WALL_TARGET_DIST` | 200mm | 目标离墙距离 | 小车离墙太近/太远时调整 |
| `WALL_DIST_KP` | 0.10 | 距离环比例系数 | 靠近/远离墙的反应太慢→调大；太抖→调小 |
| `WALL_ANGLE_KP` | 1.50 | 角度环比例系数 | 小车歪斜时修正太慢→调大；修正太猛→调小 |
| `TOF_SPACING_MM` | 143mm | 两个右侧ToF的间距 | 根据实际硬件安装距离设置 |

### 速度与转向

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `WF_SPEED_FWD` | 60 | 直行速度 (0~100) | 想跑快→调大；想稳→调小 |
| `WF_MAX_TURN_RIGHT` | 70 | 最大右转力度 | 右转不够→调大；右转太猛→调小 |
| `WF_MAX_TURN_LEFT` | 70 | 最大左转力度 | 左转不够→调大；左转太猛→调小 |
| `WF_TURN_DEADBAND` | 14 | 直行死区 | 小车一直左右抖→调大(15~20)；转向反应慢→调小(8~12) |

---

## 🚧 二、前方障碍检测

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `FRONT_OBS_DIST` | 280mm | 前方障碍触发距离 | 总是撞墙→调大(350~450)；太早触发→调小 |
| `FRONT_PANIC_DIST` | 60mm | 紧急倒车距离 | 贴脸才倒车→调大(100)；倒车太频繁→调小 |

---

## 🔄 三、胡同原地左转逃脱

> 逻辑：检测到前方有墙 → 原地左转 → 停下检测 → 还有墙就继续转 → 直到出胡同

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `ALLEY_TURN_STRENGTH` | 80 | 原地左转力度 (0~100) | 转太猛→调小(60~70)；转太慢→调大(90~100) |
| `ALLEY_TURN_MS` | 200ms | 每次转多久 | 每次转的角度太小→调大(250~400)；转太多→调小(150) |
| `ALLEY_CHECK_MS` | 80ms | 转完后检测时间 | ToF读数不稳定→调大(100~150) |
| `ALLEY_CLEAR_DIST` | 350mm | 认为"出胡同"的距离 | 出胡同后又触发→调大(400~500)；出不来→调小(300) |

### 调参示例

```
# 每次转的角度太小
PARAM:ALLEY_TURN_MS=300

# 转得太猛
PARAM:ALLEY_TURN_STRENGTH=60

# 出胡同后立刻又触发
PARAM:ALLEY_CLEAR_DIST=450
```

---

## 🔍 四、丢墙后找墙

> 逻辑：右侧看不到墙 → 向右转找墙

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `WALL_LOST_DIST` | 650mm | 判定"丢墙"的距离 | 容易误判丢墙→调大(800)；找墙太迟→调小(500) |
| `LOST_WALL_TURN` | 12 | 找墙时右转力度 | 找墙太慢→调大(20~30)；转太猛→调小(8) |
| `LOST_WALL_REACQUIRE_TH` | 180mm | 认为"找到墙"的距离 | 找到墙后又丢→调大(250) |

---

## ↩️ 五、出拐角（右墙消失时向右转）

> 逻辑：右前方看不到墙但右后方还有 → 出拐角序列

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `WF_SEQ_EXIT_STRAIGHT_MS` | 350ms | 出拐角先直行时间 | 直行太久撞墙→调小；直行不够→调大 |
| `WF_SEQ_EXIT_TURN_MS` | 450ms | 出拐角右转时间 | 右转角度不够→调大(600~800)；转太多→调小 |
| `WF_SEQ_EXIT_PAUSE_MS` | 200ms | 转完后暂停时间 | 可保持默认 |

---

## 📡 六、ToF 传感器标定

| 参数 | 默认值 | 说明 | 什么时候调 |
|------|--------|------|-----------|
| `TOF_OFFSET_F` | 0mm | 前ToF偏移量 | 前方测距偏大→设负值；偏小→设正值 |
| `TOF_OFFSET_R1` | 0mm | 右前ToF偏移量 | 同上 |
| `TOF_OFFSET_R2` | -2mm | 右后ToF偏移量 | 同上 |
| `TOF_ALPHA` | 0.50 | 滤波系数 (0~1) | 读数太抖→调小(0.3)；响应太慢→调大(0.7) |
| `TOF_JUMP_MM` | 200mm | 跳变限幅 | 读数跳动大→调小(100)；响应慢→调大(300) |

---

## 🎯 七、常见问题速查

### 小车总是撞墙
```
PARAM:FRONT_OBS_DIST=400      # 更早检测前方障碍
PARAM:ALLEY_TURN_MS=300       # 每次多转一点
PARAM:ALLEY_TURN_STRENGTH=90  # 转得更有力
```

### 小车左右抖动
```
PARAM:WF_TURN_DEADBAND=18     # 加大直行死区
PARAM:WALL_DIST_KP=0.05       # 减小距离环增益
PARAM:WALL_ANGLE_KP=1.0       # 减小角度环增益
```

### 小车离墙太近/太远
```
PARAM:WALL_TARGET_DIST=180    # 想靠近墙
PARAM:WALL_TARGET_DIST=250    # 想离墙远一点
```

### 出胡同后找不到墙
```
PARAM:WF_MAX_TURN_RIGHT=80    # 增大右转力度
PARAM:LOST_WALL_TURN=20       # 找墙时转得更快
```

### 拐角转不过来
```
PARAM:WF_SEQ_EXIT_TURN_MS=700 # 出拐角时多转一会
```

### ToF读数不稳定
```
PARAM:TOF_ALPHA=0.3           # 更平滑的滤波
PARAM:TOF_JUMP_MM=100         # 限制跳变
```

---

## 📝 调参记录模板

```
日期：____
场地：____

调整前问题：____________________

调整的参数：
- PARAM:____=____
- PARAM:____=____

调整后效果：____________________
```
